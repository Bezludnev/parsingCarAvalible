# Car Monitor Bot v2.2 - с Scheduled AI анализом

Telegram бот для мониторинга автомобилей на Bazaraki с **автоматическим AI анализом 2 раза в день** для поиска лучших предложений.

## 🆕 Новые возможности v2.2

### 🤖 Scheduled AI анализ (ГЛАВНАЯ ФИЧА)
- **Автоматический анализ** всей базы данных 2 раза в день (09:00 и 18:00)
- **Поиск лучших сделок** с анализом описаний на предмет срочности продажи
- **Топ предложения дня** с обоснованием выбора
- **Экономия токенов** - один большой анализ вместо множества мелких
- **HTML отчеты** с детальным разбором каждого предложения

### 🔍 Анализ описаний автомобилей
- Поиск признаков **срочной продажи** ("срочно", "переезд", "снижена цена")
- Оценка **технического состояния** ("отличное", "без вложений", "требует ремонта")
- Анализ **сервисной истории** ("регулярное ТО", "официальный сервис")
- Выявление **скрытых проблем** ("торг уместен", "косметический ремонт")

### 📊 Оптимизированные уведомления
- **Краткие сводки** в Telegram с ключевой информацией
- **Полные HTML отчеты** с детальным анализом
- **Топ предложения** отдельным сообщением
- **Статус расписания** для мониторинга работы

## 📋 Новые API Endpoints

### Scheduled анализ
- `POST /analysis/scheduled-analysis` - Ручной запуск scheduled анализа
- `GET /analysis/scheduler-status` - Статус планировщика заданий
- `POST /analysis/full-market` - Полный анализ рынка
- `POST /analysis/market-trends` - Анализ трендов

### HTML отчеты  
- `GET /reports/list` - Список созданных отчетов
- `GET /reports/download/{filename}` - Скачать отчет
- `DELETE /reports/cleanup` - Удалить старые отчеты
- `POST /reports/send-list-to-telegram` - Список отчетов в Telegram

### Мониторинг
- `POST /cars/check-now` - Ручная проверка новых машин
- `GET /analysis/database-stats` - Статистика базы данных
- `GET /health` - Статус системы

## 🕒 Расписание работы

- **Мониторинг новых объявлений**: каждые 5-10 минут (пауза 02:00-06:00)
- **AI анализ для поиска сделок**: 09:00 и 18:00 по времени Кипра
- **Автоматическая очистка отчетов**: старше 7 дней

## 🔧 Установка и запуск

1. **Клонировать репозиторий**
```bash
git clone <repo_url>
cd parsingCarAvalible
```

2. **Настроить .env файл**
```bash
cp .env.example .env
# Заполнить TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID, OPENAI_API_KEY
```

3. **Запустить через Docker**
```bash
make up
```

4. **Проверить работу**
```bash
make status
make check-scheduler
```

## 🛠️ Новые Makefile команды

### AI анализ
```bash
make scheduled-analysis    # Ручной запуск scheduled анализа
make check-scheduler      # Проверить статус планировщика  
make full-market-analysis # Запустить полный анализ рынка
make database-stats       # Получить статистику базы
make market-trends        # Анализ трендов рынка
make ai-status           # Статус AI сервиса
```

### Управление отчетами
```bash
make list-reports        # Список HTML отчетов
make reports-stats       # Статистика отчетов
make cleanup-reports     # Удалить старые отчеты
```

### Быстрые команды
```bash
make morning-routine     # Утренняя проверка (статус + анализ)
make test-ai-pipeline    # Тест всего AI pipeline
make deploy-check        # Проверки перед деплоем
```

## 📁 Структура отчетов

HTML отчеты сохраняются в директории `reports/`:
```
ai_analysis_scheduled_25cars_20241231_090015.html  # Утренний анализ
ai_analysis_scheduled_28cars_20241231_180012.html  # Вечерний анализ
ai_full_market_150cars_20241231_143022.html        # Полный анализ
```

## 🤖 AI анализ с фокусом на сделки

Использует модель **o3-mini** через Responses API для:
- Анализа всей базы данных одним запросом (экономия токенов)
- Поиска машин с признаками срочной продажи
- Оценки соотношения цена/качество  
- Учета климатических особенностей Кипра
- Прогноза расходов на обслуживание
- Выявления скрытых проблем в описаниях

## 💡 Преимущества новой версии

1. **Экономия до 80% токенов** OpenAI за счет анализа всей базы сразу
2. **Автоматический поиск сделок** без ручного мониторинга
3. **Глубокий анализ описаний** для выявления выгодных предложений
4. **Регулярность анализа** - 2 раза в день в оптимальное время
5. **Полные HTML отчеты** для детального изучения вариантов

## 📊 Мониторинг и отладка

### Проверка статуса системы
```bash
# Общий статус
make status

# Статус AI
make ai-status

# Статус планировщика
make check-scheduler

# Статистика базы данных
make database-stats
```

### Логи и отладка
```bash
# Логи приложения
make logs-app

# Статистика контейнеров
make stats

# Подключение к контейнеру
make shell
```

### Тестирование AI анализа
```bash
# Ручной запуск scheduled анализа
make scheduled-analysis

# Полный анализ рынка
make full-market-analysis

# Анализ трендов за 14 дней
make market-trends

# Тест всего pipeline
make test-ai-pipeline
```

## 🔄 Рабочий процесс разработки

### Утренняя рутина
```bash
make morning-routine
```

### Быстрая разработка
```bash
make dev-cycle    # Перезагрузка кода + логи
```

### Полная перезагрузка
```bash
make rebuild      # Полная пересборка
```

## 🚨 Устранение неполадок

### AI анализ не работает
```bash
# Проверить подключение к OpenAI
curl http://localhost:8000/analysis/test-connection

# Проверить статус
make ai-status

# Проверить планировщик
make check-scheduler
```

### Нет данных в базе
```bash
# Проверить статистику
make database-stats

# Запустить скрапинг
make trigger-scraping

# Проверить логи
make logs-app
```

### HTML отчеты не создаются
```bash
# Проверить права на директорию reports/
ls -la reports/

# Проверить место на диске
df -h

# Список отчетов
make list-reports
```

## 📈 Архитектура системы

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Мониторинг    │    │   AI Анализ     │    │   Уведомления   │
│                 │    │                 │    │                 │
│ ⏰ Каждые 5-10  │    │ 🤖 2 раза в     │    │ 📱 Telegram     │
│   минут         │────│   день          │────│   Bot           │
│                 │    │                 │    │                 │
│ 🔍 Скрапинг     │    │ 🎯 Поиск сделок │    │ 📄 HTML отчеты  │
│   Bazaraki      │    │   через o3-mini │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────────────────────────────────────────────────────┐
│                    База данных MySQL                            │
│  🚗 Автомобили  │  📝 Описания  │  📊 Статистика  │  ⭐ Оценки │
└─────────────────────────────────────────────────────────────────┘
```

## 🎯 Дорожная карта

### v2.3 (планируется)
- [ ] Уведомления о снижении цен
- [ ] Сравнение с историческими данными
- [ ] Интеграция с другими сайтами
- [ ] Мобильное приложение

### v2.4 (идеи)
- [ ] Машинное обучение для прогноза цен
- [ ] Автоматические звонки продавцам
- [ ] Интеграция с банками для кредитов
- [ ] Система рейтингов продавцов

## 📞 Поддержка

При возникновении проблем:

1. Проверьте логи: `make logs-app`
2. Проверьте статус: `make status`
3. Перезапустите систему: `make restart`
4. При критических ошибках: `make fresh`

---

**Car Monitor Bot v2.2** - умная система поиска автомобилей с AI анализом 🚗🤖